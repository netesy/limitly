// Test parallel blocks 
print("=== Parallel Block Tests ===");

// ==========================================
//  Batch parallel block (CPU bound)
// ==========================================
parallel(ch=messages, mode=batch, cores=Auto, on_error=Auto,
         timeout=20s, grace=500ms, on_timeout=partial) {
    task(i in 1..3) {
        print("Task {i} running");
        sleep(randint(1, 3)); //these are assumed to be system functons
        messages.send("Task {i} done");
    }
} // auto-close messages

iter (message in messages) {
    print("Received: {message}");
}

// ==========================================
//  Stream processing (CPU bound, retries)
// ==========================================
parallel(events: FileChunks, ch=files_out, mode=stream, cores=Auto,
         on_error=Retry, timeout=60s,
         grace=500ms, on_timeout=partial) {
    worker(chunk) {
        process_chunk(chunk);
        files_out.send("Chunk {chunk.id} processed");
    }
} // auto-close files_out

iter (msg in files_out) {
    print(msg);
}