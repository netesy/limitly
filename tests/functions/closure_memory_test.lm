print("=== Closure Memory Management Tests ===");

print("\n--- Test 1: Basic Closure Creation ---");
fn createSimpleClosure() : fn(int) : int {
    var x: int = 42;
    return fn(y: int) : int {
        return x + y;
    };
}

var simpleClosure = createSimpleClosure();
var result1 = simpleClosure(8);
print("Simple closure result: " + result1);

print("\n--- Test 2: Multiple Captured Variables ---");
fn createMultiVarClosure() : fn(int) : int {
    var a: int = 10;
    var b: int = 20;
    var c: int = 30;
    return fn(x: int) : int {
        return a + b + c + x;
    };
}

var multiVarClosure = createMultiVarClosure();
var result2 = multiVarClosure(5);
print("Multi-variable closure result: " + result2);

print("\n--- Test 3: Nested Closures ---");
fn createNestedClosure() : fn(int) : fn(int) : int {
    var outer: int = 100;
    return fn(middle: int) : fn(int) : int {
        var combined: int = outer + middle;
        return fn(inner: int) : int {
            return combined + inner;
        };
    };
}

var nestedClosure = createNestedClosure();
var innerClosure = nestedClosure(50);
var result3 = innerClosure(25);
print("Nested closure result: " + result3);

print("\n--- Test 4: Closure Variable Modification ---");
fn createModifyingClosure() : fn() : int {
    var counter: int = 0;
    return fn() : int {
        counter = counter + 1;
        return counter;
    };
}

var counterClosure = createModifyingClosure();
print("Counter 1: " + counterClosure());
print("Counter 2: " + counterClosure());
print("Counter 3: " + counterClosure());

print("\n--- Test 5: Shared Variable Optimization ---");
fn createSharedVarClosures() : (fn(int) : int, fn(int) : int) {
    var shared: int = 1000;
    var closure1 = fn(x: int) : int {
        return shared + x;
    };
    var closure2 = fn(y: int) : int {
        return shared * y;
    };
    return (closure1, closure2);
}

var (sharedClosure1, sharedClosure2) = createSharedVarClosures();
print("Shared closure 1: " + sharedClosure1(5));
print("Shared closure 2: " + sharedClosure2(3));

print("\n--- Test 6: Closure Cleanup Test ---");
fn createManyClosures() {
    iter (i in 1..10) {
        var localVar: int = i * 10;
        var tempClosure = fn(x: int) : int {
            return localVar + x;
        };
        var tempResult = tempClosure(i);
        print("Temp closure " + i + " result: " + tempResult);
    }
}

createManyClosures();

print("\n--- Test 7: Circular Reference Test ---");
fn createCircularTest() : fn(int) : int {
    var value: int = 42;
    var innerClosure = fn(x: int) : int {
        return value + x;
    };
    
    var outerClosure = fn(y: int) : int {
        var innerResult = innerClosure(y);
        return innerResult * 2;
    };
    
    return outerClosure;
}

var circularClosure = createCircularTest();
var result7 = circularClosure(8);
print("Circular reference test result: " + result7);

print("\n=== All Closure Memory Management Tests Complete ===");