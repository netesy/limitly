print("=== Advanced Closures Tests ===");

print("\n--- Test 1: Closure Capturing Loop Variables ---");
fn createFunctionArray(): (fn(): int, fn(): int, fn(): int) {
    var functions: (fn(): int, fn(): int, fn(): int);
    
    iter (i in 1..4) {
        if (i == 1) {
            var captured: int = i;
            functions.0 = fn(): int {
                return captured * 10;
            };
        } else if (i == 2) {
            var captured: int = i;
            functions.1 = fn(): int {
                return captured * 10;
            };
        } else if (i == 3) {
            var captured: int = i;
            functions.2 = fn(): int {
                return captured * 10;
            };
        }
    }
    
    return functions;
}

var (func1, func2, func3) = createFunctionArray();
print("func1(): " + func1());
print("func2(): " + func2());
print("func3(): " + func3());

print("\n--- Test 2: Closure Modifying Captured Variables ---");
fn createToggle(initial: bool): fn(): bool {
    var state: bool = initial;
    return fn(): bool {
        state = !state;
        return state;
    };
}

var toggle = createToggle(false);
print("toggle(): " + toggle());
print("toggle(): " + toggle());
print("toggle(): " + toggle());
print("toggle(): " + toggle());

print("\n--- Test 3: Closure with Conditional Capture ---");
fn createConditionalClosure(condition: bool, value1: int, value2: int): fn(): int {
    if (condition) {
        return fn(): int {
            return value1 * 2;
        };
    } else {
        return fn(): int {
            return value2 * 3;
        };
    }
}

var trueClosure = createConditionalClosure(true, 5, 10);
var falseClosure = createConditionalClosure(false, 5, 10);

print("trueClosure(): " + trueClosure());
print("falseClosure(): " + falseClosure());

print("\n--- Test 4: Recursive Closure ---");
fn createFactorial(): fn(int): int {
    var factorial: fn(int): int;
    factorial = fn(n: int): int {
        if (n <= 1) {
            return 1;
        } else {
            return n * factorial(n - 1);
        };
    };
    return factorial;
}

var fact = createFactorial();
print("factorial(5): " + fact(5));
print("factorial(6): " + fact(6));

print("\n--- Test 5: Closure Chain ---");
fn createChain(start: int): fn(int): fn(int): int {
    return fn(step1: int): fn(int): int {
        var intermediate: int = start + step1;
        return fn(step2: int): int {
            return intermediate * step2;
        };
    };
}

var chain = createChain(10);
var step1Result = chain(5);
var finalResult = step1Result(3);
print("chain(10)(5)(3): " + finalResult);

print("\n=== Advanced Closures Tests Complete ===");